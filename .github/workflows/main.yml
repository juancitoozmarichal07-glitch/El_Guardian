name: Build Veridian (Sin Mentiras)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 'PASO 1: Checkout del código'
        uses: actions/checkout@v4

      - name: 'PASO 2: Configurando Java (JDK 17)'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 'PASO 3: Configurando Node.js (v18)'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 'PASO 4: Instalando Cordova'
        run: npm install -g cordova

      - name: 'PASO 5: Inyectando la clave secreta de la IA'
        run: sed -i 's|const HUGGING_FACE_API_KEY = "";|const HUGGING_FACE_API_KEY = "${{ secrets.HUGGING_FACE_API_KEY }}";|' www/index.html

      - name: 'PASO 6: Añadiendo plataforma Android'
        run: cordova platform add android

      - name: 'PASO 7: Construyendo el APK'
        run: cordova build android --release -- -- --packageType=apk

      - name: 'PASO 8: Creando el Keystore'
        run: |
          keytool -genkey -v -keystore veridian-release-key.keystore \
          -alias ${{ secrets.KEYSTORE_ALIAS }} \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.KEY_PASSWORD }}" \
          -dname "CN=Veridian, OU=AI, O=Veridian Corp, L=Montevideo, S=Uruguay, C=UY"

      - name: 'PASO 9: Firmando el APK'
        run: |
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
          -keystore veridian-release-key.keystore \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.KEY_PASSWORD }}" \
          platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
          ${{ secrets.KEYSTORE_ALIAS }}

      - name: 'PASO 10: Renombrando y preparando para la subida'
        run: mv platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk veridian-final.apk

      - name: 'PASO 11: Subiendo el APK'
        uses: actions/upload-artifact@v4
        with:
          name: Veridian-APK
          path: veridian-final.apk
